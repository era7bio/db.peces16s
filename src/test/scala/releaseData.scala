package ohnosequences.db.rna16s.test

import com.amazonaws.services.s3._, transfer._
import com.amazonaws.auth._
import ohnosequences.awstools.s3._

/* Copy data in S3 generated by dropInconsistentAssignments filter to a location defined in main/scala/release.scala */
case object releaseData {

  def apply(credentials: AWSCredentialsProvider) = {
    import ohnosequences.db.rna16s.data

    val s3client = S3.create(credentials)
    val transferManager = new TransferManager(s3client.s3)

    /* This code generates a list of pairs for all objects in the source folder to the objects in the new folder (because transferManager.copy doesn't work for folders) */
    val blastdbSource = dropInconsistentAssignmentsAndGenerate.s3
    val blastdbMap = s3client
      .listObjects(blastdbSource.bucket, blastdbSource.key)
      .flatMap { obj =>
        obj.key.split('/').lastOption.map { name =>
          obj -> (data.blastDBS3 / name)
        }
      }

    copyData(transferManager)(
      (dropInconsistentAssignments.output.fasta.s3 -> data.fastaS3) ::
      (dropInconsistentAssignments.output.fasta.s3 -> data.fastaS3) ::
      (dropInconsistentAssignments.output.table.s3 -> data.id2taxasS3) ::
      blastdbMap
    )

    transferManager.shutdownNow()
  }


  def copyData(transferManager: TransferManager)(pairs: Seq[(AnyS3Address, AnyS3Address)]) = {
    pairs.foreach { case (source, target) =>
      println(s"Copying ${source}")
      println(s"     to ${target}")

      transferManager.copy(
        source.bucket, source.key,
        target.bucket, target.key
      ).waitForCompletion

      println("Done!")
    }
  }

}
